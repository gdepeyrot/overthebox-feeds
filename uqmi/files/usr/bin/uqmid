#!/bin/sh /etc/rc.common
# shellcheck disable=SC2034
# vim: set noexpandtab tabstop=4 shiftwidth=4 softtabstop=4 :
# Copyright (C) 2024 ovhcloud.com

# LTE device
device="/dev/cdc-wdm0"

_log() {
    logger -p daemon.info -t "LTE-Manager" "$@"
}

_err() {
    logger -p daemon.err -t "LTE-Manager" "$@"
}

# Function to start LTE interface
start_lte_interface() {
    if ifconfig | grep -q "wwan0"; then
        _log "LTE interface is already up."
        return 0
    fi

    _log "Bringing up LTE interface"
    ifup lte || {
        _err "Failed to bring up LTE interface"
        return 1
    }
}

# Ensure LTE interface is up
if ! ifconfig | grep -q "wwan0"; then
    start_lte_interface || exit 1
fi

# Main loop
while true; do
    # Check LTE connection status
    status=$(timeout 10 uqmi -d "$device" --get-data-status|tr -d '"')
    if [ "$?" -ne 0 ] || [ "${status}" != "connected" ]; then
        _log "LTE connection is down. Attempting to reconnect..."
        start_lte_interface || continue
        # Wait a moment before attempting to reconnect
        sleep 5
        continue
    fi

    _log "LTE connection is up."
    # Sleep for a while before checking again
    sleep 30
done
