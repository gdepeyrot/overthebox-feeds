#!/bin/sh
# vim: set noexpandtab tabstop=4 shiftwidth=4 softtabstop=4 :

HOST="proof.ovh.net"

_rule_create(){
    nft add rule ip nat socks_emitted_by_myself ip daddr "$HOST" jump socks_redir comment \" Test download proof \"
}

_rule_delete(){
    # get handle of test rule
    rule_handle=$(nft -a list chain ip nat socks_emitted_by_myself | grep "socks_redir" | awk '{print $NF}')

    # delete rule with handle value
    nft delete rule ip nat socks_emitted_by_myself handle "$rule_handle"
}

_chain_exists() {
	nft list chain ip nat "$1" 1>/dev/null 2>/dev/null
}

if ! _chain_exists "socks_emitted_by_myself" || ! _chain_exists "socks_redir"; then
	echo "Couldn't find the iptables chain to plug myself into. Is ss-redir running?"
	return 1
fi

trap : HUP INT TERM

_rule_create
curl http://$HOST/files/10Gio.dat >/dev/null || echo
_rule_delete
