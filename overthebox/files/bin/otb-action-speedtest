#!/bin/sh
# shellcheck disable=SC1091,SC2039,SC2034
# vim: set noexpandtab tabstop=4 shiftwidth=4 softtabstop=4 :

HOST="gra.perf.overthebox.net"

. /lib/overthebox
. /lib/functions.sh
. /lib/functions/network.sh

trap : HUP INT TERM

_rule_create(){
    nft add rule ip nat socks_emitted_by_myself ip daddr "$HOST" jump socks_decision comment \" Test download proof \"
}

_rule_delete(){
    # get handle of test rule
    rule_handle=$(nft -a list chain ip nat socks_emitted_by_myself | grep "socks_decision" | awk '{print $NF}')

    # delete rule with handle value
    nft delete rule ip nat socks_emitted_by_myself handle "$rule_handle"
}

_speedtest() {
	if [ "$1" = "loopback" ]; then
		return 0
	fi

	network_get_ipaddr SOURCE_IP "$1"

	if [ "$1" = "lan" ]; then
		_rule_create
		echo "Launching shadowsocks speedtest : $SOURCE_IP"
		speedtest "${SOURCE_IP}"
		_rule_delete
	else
		echo "Launching speedtest on $1 : $SOURCE_IP"
		speedtest "${SOURCE_IP}"
	fi

	echo "${SPEEDTEST}" | jq .
}

if [ "$(uci -q get "network.$1")" = interface ]; then
	speedtest "$1"
else
	config_load network
	config_foreach _speedtest interface
fi
